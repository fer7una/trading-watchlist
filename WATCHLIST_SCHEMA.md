# WATCHLIST_SCHEMA.md

Schema reference for `out/watchlist.json`. Fields are optional unless noted.

## Overview
- The watchlist is generated by the scanner + filters + RVOL + scoring.
- Profiles: `PRE` (premarket anchor) or `OPEN` (RTH anchor) influence RVOL window.
- Times are ISO-8601 strings with timezone offsets.

## Root
- `run_id` (string, UUID)
- `generated_utc` (string, ISO)
- `generated_ny` (string, ISO, America/New_York)
- `profile_used` (string, `PRE` or `OPEN`)
- `phase` (string, same as profile_used)
- `market_phase` (string, `PREMARKET` | `OPEN` | `POST` | `CLOSED`)
- `schedule_times_ny` (object, ISO timestamps for session boundaries)
- `scan` (object) scan counters
- `filters` (object) filter settings used
- `rvol` (object) RVOL config used
- `news` (object) news config used
- `symbols` (array) watchlist rows
- `tradingview` (object) export helpers

## scan
- `candidates` (int) raw scanner rows
- `prelim` (int) after snapshot + basic filters
- `filtered` (int) after float filter
- `final` (int) after RVOL/spread/sanity filters
- `invalid_last` (int) symbols with invalid last price

## filters
- `price_min` / `price_max` (float, USD)
- `change_min_pct` (float, percent)
- `volume_min` (int, shares)
- `rvol_min` (float)
- `float_max` (int, shares)
- `spread_abs_max` (float, USD)
- `spread_pct_max` (float, ratio; `0.05 = 5%`)
- `spreadAbsMax` / `spreadPctMax` (aliases for the above, camelCase)
- `spread_max` (deprecated alias of `spread_pct_max`)
- `max_candidates` (int)
- `max_rvol_symbols` (int)

## rvol
- `anchor_time_ny` (string, `HH:MM`)
- `lookback_days` (int)
- `use_rth` (bool)
- `bar_size` (string, IBKR bar size, e.g. `5 mins`)
- `method` (string, `median` | `trimmed_mean` | `mean`)
- `trim_pct` (float, only used for `trimmed_mean`)
- `min_days_valid` (int, minimum valid days in baseline)
- `baseline_floor_vol` (int, minimum baseline volume; below this RVOL is null)
- `cap` (float, max RVOL if > 0; 0 disables cap)

RVOL calculation:
- Window = sum(volume) from `anchor_time_ny` to `now` (cap at 16:00 NY).
- For past days, use the same clock window as today.
- Baseline = median / trimmed mean / mean of valid past windows.
- If `min_days_valid` not met or baseline < `baseline_floor_vol`, RVOL is null.

## news
- `lookback_hours` (int)
- `provider` (string, `fmp` | `none`)
- `enabled` (bool)
- `reason_if_disabled` (string or null, e.g. `fmp_plan_restricted`, `disabled`)

## symbols[]
Each row is a dict with:
- `symbol` (string, ticker)
- `primaryExchange` (string, e.g. `NASDAQ`)
- `tvSymbol` (string, TradingView format, e.g. `NASDAQ:NVDA`)
- `last` (float, USD)
- `prevClose` (float, USD)
- `changePct` (float, percent, `(last - prevClose) / prevClose * 100`)
- `volumeToday` (int, shares; from IB snapshot)
- `bid` / `ask` (float, USD)
- `spread` (float, USD, `ask - bid`)
- `spreadPct` (float, `spread / last`, ratio; `0.05 = 5%`)
- `floatShares` (int, shares)
- `rvol` (float, RVOL capped if `cap` > 0)
- `rvolRaw` (float, uncapped RVOL)
- `rvolScore` (float, 0..1, log-scaled score from `rvolRaw`)
- `rvolDaysValid` (int, number of valid baseline days)
- `capApplied` (bool, `true` if RVOL cap was applied)
- `hasCatalyst` (bool or null)
  - `true`: recent news found within lookback
  - `false`: API ok, no recent news
  - `null`: API missing/failed (unknown)
- `catalyst` (string or null)
  - `news` headline/summary, or `unknown`, or `unavailable`, or `corporate_action_suspect`
- `catalystProvider` (string or null, e.g. `fmp`)
- `catalystHeadline` (string or null)
- `catalystSummary` (string or null)
- `catalystPublishedAt` (string or null, ISO)
- `catalystSource` (string or null)
- `catalystUrl` (string or null)
- `catalystError` (string or null, short error label)
  - `restricted_endpoint_402`: provider plan restricted
  - `disabled`: news provider disabled
- `suspectCorporateAction` (bool)
- `suspectData` (bool)
- `grade` (string, `A`..`D`)
- `score` (float, 0..1)

## Sanity flags
Current checks:
- `suspectCorporateAction`: very low prevClose + huge change
- `suspectData`: bad numbers, huge spread, or high change on very low volume

## grade / score
- `score` is a weighted heuristic of change, RVOL, volume, float, spread.
- `grade` thresholds (simplified):
  - `A`: strong change + RVOL + volume + low float + tight spread
  - `B`: solid change + RVOL + volume
  - `C`: moderate change + RVOL
  - `D`: everything else
- Suspect flags cap the grade to `C`.

## tradingview
- `txt_symbols` (array of `tvSymbol` strings)

## schedule_times_ny
- `pre` (string, ISO)
- `market_open` (string, ISO)
- `market_close` (string, ISO)
- `post` (string, ISO)

## Minimal example
```json
{
  "run_id": "3b71a4d4-5b6c-4b2c-9d3b-0a2c9a0f1cde",
  "generated_utc": "2024-05-01T13:45:00+00:00",
  "generated_ny": "2024-05-01T09:45:00-04:00",
  "profile_used": "OPEN",
  "phase": "OPEN",
  "market_phase": "OPEN",
  "schedule_times_ny": {
    "pre": "2024-05-01T04:00:00-04:00",
    "market_open": "2024-05-01T09:30:00-04:00",
    "market_close": "2024-05-01T16:00:00-04:00",
    "post": "2024-05-01T20:00:00-04:00"
  },
  "scan": {
    "candidates": 20,
    "prelim": 12,
    "filtered": 8,
    "final": 3,
    "invalid_last": 1
  },
  "filters": {
    "price_min": 2.0,
    "price_max": 20.0,
    "change_min_pct": 10.0,
    "volume_min": 200000,
    "rvol_min": 3.0,
    "float_max": 10000000,
    "spread_abs_max": 0.0,
    "spread_pct_max": 0.05,
    "spread_max": 0.05,
    "spreadAbsMax": 0.0,
    "spreadPctMax": 0.05,
    "max_candidates": 50,
    "max_rvol_symbols": 15
  },
  "rvol": {
    "anchor_time_ny": "09:30",
    "lookback_days": 7,
    "use_rth": true,
    "bar_size": "5 mins",
    "method": "median",
    "trim_pct": 0.15,
    "min_days_valid": 5,
    "baseline_floor_vol": 50000,
    "cap": 200.0
  },
  "news": {
    "lookback_hours": 24,
    "provider": "fmp",
    "enabled": true,
    "reason_if_disabled": null
  },
  "symbols": [
    {
      "symbol": "ABC",
      "primaryExchange": "NASDAQ",
      "tvSymbol": "NASDAQ:ABC",
      "last": 8.25,
      "prevClose": 7.10,
      "changePct": 16.2,
      "volumeToday": 1250000,
      "bid": 8.24,
      "ask": 8.26,
      "spread": 0.02,
      "spreadPct": 0.0024,
      "floatShares": 4500000,
      "rvol": 5.4,
      "rvolRaw": 5.9,
      "rvolScore": 0.74,
      "rvolDaysValid": 6,
      "capApplied": false,
      "hasCatalyst": true,
      "catalyst": "New contract wins major customer",
      "catalystProvider": "fmp",
      "catalystHeadline": "ABC wins major customer",
      "catalystSummary": "ABC announced a new contract...",
      "catalystPublishedAt": "2024-05-01T12:15:00+00:00",
      "catalystSource": "ExampleNews",
      "catalystUrl": "https://example.com/news/abc",
      "catalystError": null,
      "suspectCorporateAction": false,
      "suspectData": false,
      "grade": "B",
      "score": 0.72
    }
  ],
  "tradingview": {
    "txt_symbols": ["NASDAQ:ABC"]
  }
}
```
